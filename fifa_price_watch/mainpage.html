<!DOCTYPE html> <html><head>
    <meta charset="utf-8"/>
        <title>FIFA Consumable Trading</title> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js"></script>
    </head>
    <body>
    <canvas id = "testchart" width="500" height="500"></canvas>
    
    <script>
    function getData(req)//reads in data from data.json and initializes global data holders
    {
        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200)
            {
                let data = JSON.parse(this.responseText);
                console.log("Data successfully parsed from server");
                if (req == "fitness")
                {
                    let fitnessdata = data.fitness;
                    processData(fitnessdata, "fitness");
                }
                else if (req == "position")
                {
                    let positiondata = data.position;
                    processData(positiondata, "position");
                }
                else if (req == "chemistry")
                {
                    let chemistrydata = data.chemistry;
                    processData(chemistrydata, "chemistry");
                }
            }
        };
        xhttp.open("GET", "processed_data.json");
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.send();
    }
    function processData(data, req)
    {
        /*previous 24 hours*/
        let start = new Date(new Date().getTime() - 20*60*60*1000); /*In UTC time, need to convert back later*/
        let minutes = 0
        if (start.getMinutes()>=30)
            minutes = 30;
        start.setMinutes(minutes);
        let dates_array = []
        if (req == "fitness")
        {
            let bronze_array = []
            let silver_array = []
            let gold_array = []
        }
        else if (req == "position")
        {
            let 
        }
        days_data = data.slice(-48);
        for (let i = 0; i < 48; i++)
        {
            let date = generateQuery(new Date(start.getTime() + i*30*60*1000));
            /*when implementing timezones, make a new start date object with adjusted date/time, get query from
            generateQuery, but don't use query -> instead convert to label using generateDateLabel*/
            let dict = days_data[i];
            let dateLabel = generateDateLabel(date);
            for (let key in dict)
            {
                gold_array.push(dict[key].gold);
                silver_array.push(dict[key].silver);
                bronze_array.push(dict[key].bronze);
                dates_array.push(dateLabel);
            }
        }
        generateFitnessChart(dates_array, bronze_array, silver_array, gold_array);
    }
    function generateQuery(date)
    {
        let year = date.getFullYear().toString();
        let check_month = date.getMonth() + 1;
        if (check_month == 12)
            check_month = 0;
        let month = getStr(check_month);
        let day = getStr(date.getDate());
        let hour = getStr(date.getHours());
        let minute = getStr(date.getMinutes());
        let query = hour.concat("_", minute, "_", year, "_", month, "_", day);
        return query;
    }

    function generateDateLabel(query)
    {
        let hour = query.substring(0,2);
        let minute = query.substring(3,5);
        let year = query.substring(6,10);
        let month_num = query.substring(11,13);
        let day = query.substring(14,16);
        let month;
        switch(parseInt(month_num)){
            case 1:
                month = "January";
                break;
            case 2:
                month = "February";
                break;
            case 3:
                month = "March";
                break;
            case 4:
                month = "April";
                break;
            case 5:
                month = "May";
                break;
            case 6:
                month = "June";
                break;
            case 7:
                month = "July";
                break;
            case 8:
                month = "August";
                break;
            case 9:
                month = "September";
                break;
            case 10:
                month = "October";
                break;
            case 11:
                month = "November";
                break;
            case 12:
                month = "December";
                break;
        }
        let retstr = month.concat(" ", day, ", ", year, " ", hour, ":", minute);
        return retstr;
    }
    
    function getStr(num)
    {
        if (num < 10)
            return '0'.concat(num.toString());
        else
            return num.toString();
    }
    
    function generateFitnessChart(dates, bronze, silver, gold)
    {
        let select = $("#testchart")
        let mychart = new Chart(select, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Bronze Squad Fitness',
                data: bronze,
                borderColor: "#cd7f32",
                fill: false
            },
            {
                label: 'Silver Squad Fitness',
                data: silver,
                borderColor: "#C0C0C0",
                fill: false
            },
            {
                label: 'Gold Squad Fitness',
                data: gold,
                borderColor: "#FFD700",
                fill:false
            }]
        },
        options: {
            maintainAspectRatio: false,
        },
        });
    }

    //event listeners
    $(document).ready(function(){
        getData("fitness");
    });
    </script>
    <hr>
    </body></html>
    